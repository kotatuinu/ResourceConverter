# VC リソースコンバーター

Visual C++（.NET Frameworkではない方）のGUIアプリで作られた古いプログラムを別の言語に移植するのに、リソース（rcファイル）の移植はどうしたら良いのかと考え、リソースをを解析して変換するツールを作ってみようと思った次第で。
作りながら考えております。
開発履歴として、作っている途中に考えた無い様を熟々と述べてみます。


## 開発履歴

1. VCのリソースをC#に移植するのに、変換を行うツールを作ってみる。
考えを纏めてみる。  
・VC\++のリソースファイルのフォーマットの仕様はあるか？  
→ググってみたけど具体的な物はない。VC++でGUIアプリでフォームやダイアログを作り、部品を貼り付けてパラメタを設定し、その内容を解析するしかなさそう。  
→GUI部品は色々あるが、全部やるのは大変。とりあえずよく使いそうな物からやってみる。

1. 長々と考えて動かない物を作るより、処理の段階を踏んで順に作って動かして確認していった方が、確認作業が簡単になるし、モチベーションも維持しやすい。  
以下の順で作ってみる。  
（１）リソースファイルを読み込む  
（２）読み込んだリソースファイルを解析対象か判定する。正規表現を使えばできる。  
（３）解析対象のパラメタを分割する方法を考える。正規表現を遣えば出来る。正規表現の丸括弧をキャプチャする。  
（４）分割したパラメタを遣って、変換先言語のGUIソースを構築する。ターゲットはVisual StudioのC#にする。

1. どうやって作るか考えたこと  
・フォーム・ダイアログの部品は、改行が入ることがある。例えばラベル（Static）のCaption（表示内容）が長い場合など（表示内容に改行を入れる場合は"\n"になるので対象ではない）。リソースを1行ずつ読み込むことになるので、以下の2つの正規表現が必要。  
(1) 該当する部品であるか判定するため、先頭部分のみの正規表現  
(2) 該当部品のパラメタを分割するための正規表現  
→(1)でヒットしても(2)でパラメタを取得できない場合、次の行が改行されていると思われる。(1)にヒットしなかったら、前に読み込んだ行の後ろに追加して(2)を行う。なお、改行された次の行の前にある空白は削除しないと(2)の正規表現にヒットしなくなるので注意。←2020/11/8 未実装  
・正規表現で取得した複数の情報を配列として取得する。その結果をC#のフォーム・ダイアログを生成する処理に変換する処理に食わせる。←~~2020/11/8 未実装~~  
・パラメタ分割の正規表現を全て1つの配列に入れて、リソースの1行がいずれかの正規表現にヒットするか配列要素を参照していく処理でもいいけど、リソースで出現する順番がある。状態遷移①フォーム・ダイアログに入る前（DIALOGが出てくるまで）、②フォーム・ダイアログのパラメタ（BEGINが出てくるまで）、③フォーム・ダイアログに貼り付けている部品（ENDが出てくるまで）の3つの状態がある。状態毎に使用する正規表現（群）を分けた方が処理が見やすくなる。  
→［状態と正規表現リスト、次の状態］を配列で持つか、Stateパターンとしてクラスに分けて持つか。前者は1か所にまとめて記述できるので纏めて見るときはやりやすいかも。後者は、クラス毎の役割が明確になり、多くの正規表現を並べることにならないのでこぢんまりして見易い。  
→実装してみたら、前者は正規表現のテストするのに状態遷移しないと②フォーム・ダイアログのパラメタ、③フォーム・ダイアログに貼り付けている部品 のテストができなくなる。難しくはないけど、手間がかかるのはいかがなものか。TDDでやるなら後者で実装するべき。 ~~（まだテストを書いていないけど）~~  
→リソースの解析の結果を結果に入れてみたけど、例えば部品のリソースIDがパラメタ（"タブ位置"ならWS_TABSTOP）と同じ値にしたら、変換するときパラメタなのか部品のリソースIDなのか区別できない事に気付いた。2020/11/29  
というわけで、結果は”どこの部分を分割した物か”を知らないとダメだ。正規表現の名前付きキャプチャ”(?\<name\>subexpression)”を使うことでグループの名前を設定できる（"name"の部分は任意の文字列）。同じ名前を付けたキャプチャを複数のグループに付けると、1つに纏めてくれる。名前を付けないと番号が入る。  
部品のパラメタのフォーマットは・・・まだよく分かっていない・・・。  
とりあえず以下のフォーマットの種類がある。  
・(空白)CONTROL(空白)"表示内容",リソースID,"部品種別",パラメタ1(|パラメタ1・・・),左上x座標,左上y座標,幅,高さ,パラメタ2(|パラメタ2・・・),ヘルプID  
・(空白)部品種類(空白)"表示内容",リソースID,左上x座標,左上y座標,幅,高さ,パラメタ1(|パラメタ1・・・),パラメタ2(|パラメタ2・・・),ヘルプID  
・(空白)部品種類(空白)リソースID,左上x座標,左上y座標,幅,高さ,パラメタ1(|パラメタ1・・・),パラメタ2(|パラメタ2・・・),ヘルプID  
　  
※：パラメタが多くなると部品種類が"CONTROL"となる。  
※：ヘルプIDをtrueとすると、最後の項目にリソースIDの頭に"H"をつけた形の値を設定される。  
※：パラメタが全くない場合は、その項目は省略される。正規表現的には丸括弧で括ってグループにして"?"を付けることで、無しか1つ出現ことを判定できる。  
※：前のパラメタが無く、後のパラメタがある場合、0が設定される。  
　  
・Stateパターンだと、ConcreteStateの各クラスの生成する仕組みがほしいので、Builderクラスを追加（Builderパターンにはなっていない）。状態に対するクラスをDictionaryでもっておいて、次の状態を渡されたら、それに対するインスタンスを返す。  
